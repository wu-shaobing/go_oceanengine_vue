# 操作日志模块

## 1. 现状与功能

- 日志查询：按用户、模块、操作、状态码、时间范围分页检索。
- 模块枚举：获取已有日志中的模块列表，便于前端筛选。
- 批量删除：按时间阈值删除早于指定时间的日志。
- 表与清理：`sys_operation_log` 已迁移；`backend/cmd/task/main.go` 含每日清理 30 天前历史的任务。
- 默认行为：当前项目未将操作日志自动写入数据库；仅有 zap 请求日志中间件输出到日志（非持久化）。

## 2. 数据模型

### 2.1 操作日志表（Go 模型）

```go
// backend/internal/app/admin/model/user.go
type OperationLog struct {
    ID        uint64    `gorm:"primaryKey" json:"id"`
    UserID    uint64    `gorm:"index;default:0" json:"user_id"`
    Username  string    `gorm:"size:64" json:"username"`
    Module    string    `gorm:"size:64;index" json:"module"`
    Action    string    `gorm:"size:64" json:"action"`
    Method    string    `gorm:"size:16" json:"method"`
    Path      string    `gorm:"size:255" json:"path"`
    Query     string    `gorm:"type:text" json:"query"`
    Body      string    `gorm:"type:text" json:"body"`
    Response  string    `gorm:"type:text" json:"response"`
    IP        string    `gorm:"size:50" json:"ip"`
    UserAgent string    `gorm:"size:500" json:"user_agent"`
    Status    int       `gorm:"default:0" json:"status"`
    Latency   int64     `gorm:"default:0" json:"latency"` // 毫秒
    ErrorMsg  string    `gorm:"type:text" json:"error_msg"`
    CreatedAt time.Time `gorm:"index" json:"created_at"`
}
```

### 2.2 建表摘要（见 docs/backend/02-database-design.md）

- 主索引：`id`；常用索引：`user_id`、`module`、`created_at`。

## 3. API 接口（后端已实现）

定义位置：`backend/internal/router/router.go` -> `/api/v1/system/logs/*`

| 方法 | 路径 | 说明 | 入参（Query 或 JSON） |
|---|---|---|---|
| GET | `/api/v1/system/logs/operation` | 日志列表 | `user_id, username, module, action, status, start_time, end_time, page, page_size` |
| GET | `/api/v1/system/logs/modules` | 模块枚举 | 无 |
| DELETE | `/api/v1/system/logs/operation` | 批量删除 | JSON: `{ "before_time": "2006-01-02 15:04:05" }` |

## 4. DTO 定义（节选）

```go
// backend/internal/app/admin/dto/user.go
// 查询请求
type OperationLogListReq struct {
    utils.Pagination
    UserID    uint64 `form:"user_id"`
    Username  string `form:"username"`
    Module    string `form:"module"`
    Action    string `form:"action"`
    Status    *int   `form:"status"`
    StartTime string `form:"start_time"`
    EndTime   string `form:"end_time"`
}

// 列表响应项
type OperationLogResp struct {
    ID        uint64 `json:"id"`
    UserID    uint64 `json:"user_id"`
    Username  string `json:"username"`
    Module    string `json:"module"`
    Action    string `json:"action"`
    Method    string `json:"method"`
    Path      string `json:"path"`
    IP        string `json:"ip"`
    UserAgent string `json:"user_agent"`
    Request   string `json:"request"`
    Response  string `json:"response"`
    Status    int    `json:"status"`
    Duration  int64  `json:"duration"`
    CreatedAt string `json:"created_at"`
}

// 删除请求
type OperationLogDeleteReq struct {
    BeforeTime string `json:"before_time" binding:"required"`
}
```

## 5. 中间件与写入策略（当前实现与建议）

- 现有中间件：`backend/internal/middleware/logger.go`（zap 请求日志）。
  - 记录：`request_id`、`status`、`method`、`path`、`query`、`ip`、`user_agent`、`latency`。
  - 非生产模式下可记录小体积请求体；当 `status>=400` 时记录响应体（均有限制大小）。
  - 不写入数据库。
- 若需“入库审计日志”，建议新增一个 OperationLog 中间件（挂载在 `JWTAuth` 之后），示例思路：
  1) 缓存请求体、包装 `ResponseWriter` 捕获响应；
  2) 从 `Context` 读取 `userID/roleID/username`；
  3) 对敏感字段（password/token/secret 等）脱敏；
  4) 限制请求/响应体最大记录长度（如 4KB）；
  5) 异步 `Create` 到 `sys_operation_log`（必要时批量）。

> 提示：为避免数据库压力，生产环境可开启“仅错误入库（status>=400）”或抽样入库。

## 6. 清理与保留策略

- 任务：`backend/cmd/task/main.go:338-351` 每日清理 30 天前日志。
- 若需可配置保留天数，建议在 `config/settings.yml` 增加 `operation_log.retention_days` 并在任务中读取。

## 7. 前端展示建议

- 列表字段：用户名、模块、操作、方法、路径、状态码、耗时(ms)、时间。
- 筛选：模块下拉、状态码区间、时间范围；用户名模糊查询。
- 详情：显示 `request` 与 `response`（截断展示），并高亮 `status>=400` 的记录。

## 8. 注意事项

1. 严格脱敏：密码、令牌、密钥等敏感字段统一替换为 `******`。
2. 控制体积：限制请求/响应体写入长度，防止存储暴涨。
3. 避免噪声：过滤健康检查等高频接口。
4. 合规保留：按合规要求设定保留期并支持导出备份。
