# Admin 后台架构设计

## 1. 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                        Frontend (Vue 3)                      │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────────────┐ │
│  │  Login  │  │  User   │  │  Role   │  │  Menu/Log/...   │ │
│  │  Page   │  │ Manage  │  │ Manage  │  │    Manage       │ │
│  └────┬────┘  └────┬────┘  └────┬────┘  └───────┬─────────┘ │
│       │            │            │               │           │
│       └────────────┴────────────┴───────────────┘           │
│                           │                                  │
│                    ┌──────┴──────┐                          │
│                    │   Pinia     │                          │
│                    │ (auth store)│                          │
│                    └──────┬──────┘                          │
└───────────────────────────┼─────────────────────────────────┘
                            │ HTTP (Axios)
┌───────────────────────────┼─────────────────────────────────┐
│                     Backend (Go + Gin)                       │
│                           │                                  │
│  ┌────────────────────────┴────────────────────────────┐    │
│  │                    Middleware                        │    │
│  │  ┌─────────┐ ┌──────────┐ ┌────────┐ ┌──────────┐  │    │
│  │  │  CORS   │ │ RateLimit│ │ Logger │ │ Security │  │    │
│  │  └─────────┘ └──────────┘ └────────┘ └──────────┘  │    │
│  │                    ┌──────────┐                     │    │
│  │                    │ JWT Auth │                     │    │
│  │                    └──────────┘                     │    │
│  └─────────────────────────┬───────────────────────────┘    │
│                            │                                 │
│  ┌─────────────────────────┴───────────────────────────┐    │
│  │                   Router Layer                       │    │
│  │    /api/v1/auth/*  /api/v1/system/*                 │    │
│  └─────────────────────────┬───────────────────────────┘    │
│                            │                                 │
│  ┌─────────────────────────┴───────────────────────────┐    │
│  │                   API Handler                        │    │
│  │  ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐ ┌───────────┐ │    │
│  │  │ Auth │ │ User │ │ Role │ │ Menu │ │ OpLog/... │ │    │
│  │  └──┬───┘ └──┬───┘ └──┬───┘ └──┬───┘ └─────┬─────┘ │    │
│  └─────┼────────┼────────┼────────┼───────────┼───────┘    │
│        │        │        │        │           │             │
│  ┌─────┴────────┴────────┴────────┴───────────┴───────┐    │
│  │                  Service Layer                      │    │
│  │   Business Logic, Validation, Transaction          │    │
│  └─────────────────────────┬───────────────────────────┘    │
│                            │                                 │
│  ┌─────────────────────────┴───────────────────────────┐    │
│  │                  Repository/Model                    │    │
│  │                    (GORM ORM)                       │    │
│  └─────────────────────────┬───────────────────────────┘    │
└────────────────────────────┼────────────────────────────────┘
                             │
                    ┌────────┴────────┐
                    │  MySQL/SQLite   │
                    └─────────────────┘
```

## 2. 目录结构

### 后端目录
```
backend/internal/app/admin/
├── api/                    # HTTP Handler 层
│   ├── auth.go            # 认证接口 (登录/登出/刷新Token)
│   ├── captcha.go         # 验证码接口
│   ├── user.go            # 用户管理接口
│   ├── role.go            # 角色管理接口
│   ├── menu.go            # 菜单管理接口
│   ├── operation_log.go   # 操作日志接口
│   └── dict.go            # 字典管理接口
│
├── dto/                    # Data Transfer Object
│   ├── user.go            # 用户相关 DTO
│   └── dict.go            # 字典相关 DTO
│
├── model/                  # 数据模型 (GORM)
│   ├── user.go            # User, Role, Menu, RoleMenu, OperationLog
│   └── dict.go            # Dict, DictData
│
└── service/               # 业务逻辑层
    ├── auth.go            # 认证服务
    ├── auth_test.go       # 认证测试
    ├── captcha.go         # 验证码服务
    ├── user.go            # 用户服务
    ├── role.go            # 角色服务
    ├── menu.go            # 菜单服务
    ├── operation_log.go   # 操作日志服务
    └── dict.go            # 字典服务
```

### 前端目录
```
frontend/src/
├── api/
│   └── auth.ts            # 认证 API
│
├── stores/
│   └── auth.ts            # 认证状态管理
│
├── router/
│   ├── routes.ts          # 路由定义
│   └── guards.ts          # 路由守卫
│
└── views/system/
    ├── UserManage.vue     # 用户管理页面
    ├── RoleManage.vue     # 角色管理页面
    ├── MenuManage.vue     # 菜单管理页面
    ├── SystemLogs.vue     # 操作日志页面
    └── SystemSettings.vue # 系统设置页面
```

## 3. 核心设计模式

### 3.1 分层架构
```
Handler (API) → Service → Repository (Model)
     ↓              ↓            ↓
   请求处理      业务逻辑      数据访问
```

### 3.2 依赖注入
```go
// Router 注入依赖
func (r *Router) registerSystemRoutes(rg *gin.RouterGroup) {
    userService := service.NewUserService(r.db)
    userAPI := adminApi.NewUserAPI(userService)
    // ...
}
```

### 3.3 统一响应格式
```go
// pkg/response/response.go
type Response struct {
    Code      int         `json:"code"`
    Message   string      `json:"message"`
    Data      interface{} `json:"data,omitempty"`
    RequestID string      `json:"request_id,omitempty"`
}
```

## 4. 数据模型关系

```
┌──────────┐     N:1     ┌──────────┐
│   User   │────────────▶│   Role   │
└──────────┘             └──────────┘
                              │
                              │ N:M
                              ▼
                         ┌──────────┐
                         │   Menu   │
                         └──────────┘
                              │
                              │ 自关联
                              ▼
                         ┌──────────┐
                         │ Children │
                         └──────────┘
```

## 5. 认证流程

```
1. 登录请求
   POST /api/v1/auth/login
   ├── 验证用户名密码
   ├── 检查用户状态
   ├── 生成 JWT Token
   └── 返回 access_token + refresh_token

2. 请求鉴权
   任意 API 请求
   ├── middleware/jwt.go 拦截
   ├── 解析 Authorization Header
   ├── 验证 Token 有效性
   ├── 提取 Claims (UserID, RoleKey, DataScope)
   └── 注入 Context

3. Token 刷新
   POST /api/v1/auth/refresh
   ├── 验证 refresh_token
   ├── 生成新 access_token
   └── (可选) 生成新 refresh_token
```

## 6. 配置项

```yaml
# config/settings.yml
jwt:
  secret_key: "your-secret-key"   # JWT 签名密钥
  issuer: oceanengine             # 签发者
  access_expire: 2h               # Access Token 有效期
  refresh_expire: 168h            # Refresh Token 有效期 (7天)
```

## 7. 扩展点

### 7.1 添加新模块
1. 在 `model/` 添加数据模型
2. 在 `dto/` 添加请求/响应结构
3. 在 `service/` 添加业务逻辑
4. 在 `api/` 添加 HTTP Handler
5. 在 `router.go` 注册路由

### 7.2 添加权限控制
1. 在 `sys_menu` 表添加权限标识
2. 在 middleware 中校验权限
3. 前端使用 `v-permission` 指令控制按钮显示
