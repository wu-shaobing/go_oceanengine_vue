# 菜单管理模块

## 1. 功能概述

| 功能 | 说明 |
|------|------|
| 菜单树 | 获取完整菜单树结构 |
| 用户菜单 | 根据角色权限获取用户可访问的菜单 |
| 菜单 CRUD | 创建/修改/删除菜单 |
| 权限标识 | 菜单关联权限标识用于细粒度控制 |

## 2. 数据模型

### 2.1 菜单表 (sys_menu)

```go
// backend/internal/app/admin/model/user.go
type Menu struct {
    ID         uint64         `gorm:"primaryKey" json:"id"`
    ParentID   uint64         `gorm:"default:0;index" json:"parent_id"`   // 父菜单ID, 0为顶级
    Name       string         `gorm:"size:64;not null" json:"name"`       // 菜单名称
    Path       string         `gorm:"size:255" json:"path"`               // 路由路径
    Component  string         `gorm:"size:255" json:"component"`          // 组件路径
    Icon       string         `gorm:"size:64" json:"icon"`                // 图标
    Sort       int            `gorm:"default:0" json:"sort"`              // 排序
    Permission string         `gorm:"size:128" json:"permission"`         // 权限标识
    Type       int8           `gorm:"default:1" json:"type"`              // 类型: 1-目录,2-菜单,3-按钮
    Visible    int8           `gorm:"default:1" json:"visible"`           // 是否可见
    Status     int8           `gorm:"default:1" json:"status"`            // 状态
    IsFrame    int8           `gorm:"default:0" json:"is_frame"`          // 是否外链
    IsCache    int8           `gorm:"default:0" json:"is_cache"`          // 是否缓存
    Remark     string         `gorm:"size:500" json:"remark"`
    CreatedAt  time.Time      `json:"created_at"`
    UpdatedAt  time.Time      `json:"updated_at"`
    DeletedAt  gorm.DeletedAt `gorm:"index" json:"-"`

    // 子菜单 (非数据库字段, 用于构建树结构)
    Children []*Menu `gorm:"-" json:"children,omitempty"`
}
```

> **说明**: Menu 模型也包含 `DeletedAt` 字段（与 User/Role 一致），支持软删除。

### 2.2 菜单类型常量

```go
const (
    MenuTypeDir    = 1 // 目录
    MenuTypeMenu   = 2 // 菜单
    MenuTypeButton = 3 // 按钮
)
```

### 2.3 菜单树结构示例

```
系统管理 (目录, type=1)
├── 用户管理 (菜单, type=2)
│   ├── 新增用户 (按钮, type=3, permission="system:user:create")
│   ├── 编辑用户 (按钮, type=3, permission="system:user:update")
│   └── 删除用户 (按钮, type=3, permission="system:user:delete")
├── 角色管理 (菜单, type=2)
│   └── ...
└── 菜单管理 (菜单, type=2)
    └── ...
```

## 3. 服务层实现

### 3.1 获取菜单树

```go
// backend/internal/app/admin/service/menu.go
func (s *MenuService) GetTree(ctx context.Context) ([]*dto.MenuTree, error) {
    var menus []*model.Menu
    s.db.Order("sort ASC, id ASC").Find(&menus)
    return s.buildMenuTree(menus, 0), nil
}

func (s *MenuService) buildMenuTree(menus []*model.Menu, parentID uint64) []*dto.MenuTree {
    var tree []*dto.MenuTree
    for _, menu := range menus {
        if menu.ParentID == parentID {
            node := &dto.MenuTree{
                ID:         menu.ID,
                ParentID:   menu.ParentID,
                Name:       menu.Name,
                Path:       menu.Path,
                Component:  menu.Component,
                Icon:       menu.Icon,
                Sort:       menu.Sort,
                Type:       menu.Type,
                Permission: menu.Permission,
                Status:     menu.Status,
                Hidden:     menu.Visible == 0,
                Children:   s.buildMenuTree(menus, menu.ID), // 递归构建子树
            }
            tree = append(tree, node)
        }
    }
    return tree
}
```

### 3.2 获取用户菜单 (按角色过滤)

```go
func (s *MenuService) GetUserMenuTree(ctx context.Context, roleID uint64) ([]*dto.MenuTree, error) {
    // 1. 获取角色关联的菜单ID
    var roleMenus []model.RoleMenu
    s.db.Where("role_id = ?", roleID).Find(&roleMenus)
    
    if len(roleMenus) == 0 {
        return []*dto.MenuTree{}, nil
    }

    menuIDs := make([]uint64, len(roleMenus))
    for i, rm := range roleMenus {
        menuIDs[i] = rm.MenuID
    }

    // 2. 获取菜单 (仅启用状态)
    var menus []*model.Menu
    s.db.Where("id IN ? AND status = ?", menuIDs, model.UserStatusEnabled).
        Order("sort ASC, id ASC").Find(&menus)

    return s.buildMenuTree(menus, 0), nil
}
```

### 3.3 创建菜单

```go
func (s *MenuService) Create(ctx context.Context, req *dto.MenuCreateReq) error {
    menu := &model.Menu{
        ParentID:   req.ParentID,
        Name:       req.Name,
        Path:       req.Path,
        Component:  req.Component,
        Icon:       req.Icon,
        Sort:       req.Sort,
        Type:       req.Type,
        Permission: req.Permission,
        Status:     req.Status,
        Visible:    1 - req.Hidden, // Hidden 转 Visible
        Remark:     req.Remark,
    }
    return s.db.Create(menu).Error
}
```

### 3.4 删除菜单 (级联检查)

```go
func (s *MenuService) Delete(ctx context.Context, id uint64) error {
    // 1. 检查是否有子菜单
    var childCount int64
    s.db.Model(&model.Menu{}).Where("parent_id = ?", id).Count(&childCount)
    if childCount > 0 {
        return errcode.New(errcode.ErrMenuHasChildren)
    }

    // 2. 删除角色菜单关联
    s.db.Where("menu_id = ?", id).Delete(&model.RoleMenu{})

    // 3. 删除菜单
    return s.db.Delete(&model.Menu{}, id).Error
}
```

## 4. API 接口

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/api/v1/system/menus` | 菜单列表 (扁平) |
| GET | `/api/v1/system/menus/tree` | 菜单树 (全部) |
| GET | `/api/v1/system/menus/user` | 当前用户菜单树 |
| POST | `/api/v1/system/menus` | 创建菜单 |
| GET | `/api/v1/system/menus/:id` | 菜单详情 |
| PUT | `/api/v1/system/menus/:id` | 更新菜单 |
| DELETE | `/api/v1/system/menus/:id` | 删除菜单 |

## 5. DTO 定义

### 5.1 菜单树节点

```go
// dto/user.go
type MenuTree struct {
    ID         uint64      `json:"id"`
    ParentID   uint64      `json:"parent_id"`
    Name       string      `json:"name"`
    Path       string      `json:"path"`
    Component  string      `json:"component"`
    Icon       string      `json:"icon"`
    Sort       int         `json:"sort"`
    Type       int8        `json:"type"`
    Permission string      `json:"permission"`
    Status     int8        `json:"status"`
    Hidden     int8        `json:"hidden"`       // 是否隐藏 (1=隐藏, 0=显示)
    Children   []*MenuTree `json:"children"`
}
```

### 5.2 菜单创建请求

```go
type MenuCreateReq struct {
    ParentID   uint64 `json:"parent_id"`
    Name       string `json:"name" binding:"required,max=64"`
    Path       string `json:"path"`
    Component  string `json:"component"`
    Icon       string `json:"icon"`
    Sort       int    `json:"sort"`
    Type       int8   `json:"type" binding:"required,oneof=1 2 3"`
    Permission string `json:"permission"`
    Status     int8   `json:"status"`
    Hidden     int8   `json:"hidden"`
    Remark     string `json:"remark"`
}
```

## 6. 前端实现

### 6.1 动态路由

```typescript
// 根据后端返回的菜单生成路由
function generateRoutes(menus: MenuTree[]): RouteRecordRaw[] {
  return menus
    .filter(menu => menu.type !== 3) // 过滤掉按钮
    .map(menu => ({
      path: menu.path,
      name: menu.name,
      component: () => import(`@/views/${menu.component}.vue`),
      meta: {
        title: menu.name,
        icon: menu.icon,
        hidden: menu.hidden === 1,
        permission: menu.permission
      },
      children: menu.children ? generateRoutes(menu.children) : []
    }))
}
```

### 6.2 菜单组件

```vue
<!-- AppSidebar.vue -->
<template>
  <nav class="sidebar">
    <template v-for="menu in menus" :key="menu.id">
      <template v-if="!menu.hidden">
        <!-- 目录 (有子菜单) -->
        <div v-if="menu.children?.length" class="menu-group">
          <div class="menu-title">
            <i :class="menu.icon"></i>
            {{ menu.name }}
          </div>
          <router-link
            v-for="child in menu.children"
            :key="child.id"
            :to="child.path"
            v-show="!child.hidden"
          >
            {{ child.name }}
          </router-link>
        </div>
        <!-- 菜单 -->
        <router-link v-else :to="menu.path">
          <i :class="menu.icon"></i>
          {{ menu.name }}
        </router-link>
      </template>
    </template>
  </nav>
</template>
```

## 7. 权限标识设计

### 7.1 命名规范

```
{模块}:{功能}:{操作}

例如:
- system:user:list      # 用户列表
- system:user:create    # 创建用户
- system:user:update    # 更新用户
- system:user:delete    # 删除用户
- advertiser:campaign:list
- qianchuan:ad:create
```

### 7.2 前端使用

```vue
<template>
  <button v-permission="'system:user:create'">添加用户</button>
  <button v-permission="['system:user:update', 'system:user:delete']">批量操作</button>
</template>
```

## 8. 预置菜单

```go
// cmd/migrate/main.go - runSeed()
menus := []adminModel.Menu{
    {ParentID: 0, Name: "系统管理", Path: "/system", Component: "Layout", Icon: "setting", Sort: 1, Type: 1},
    {ParentID: 0, Name: "广告管理", Path: "/ads", Component: "Layout", Icon: "promotion", Sort: 2, Type: 1},
    {ParentID: 0, Name: "数据报表", Path: "/report", Component: "Layout", Icon: "data-analysis", Sort: 3, Type: 1},
}
```

## 9. 注意事项

1. **ParentID=0 表示顶级菜单**
2. **删除前检查子菜单**: 有子菜单时不允许删除
3. **删除时清理关联**: 同时删除 sys_role_menu 中的关联
4. **排序字段**: Sort 数值越小越靠前
5. **Visible vs Hidden**: 数据库存 Visible=1 表示可见, DTO 用 Hidden 方便前端
