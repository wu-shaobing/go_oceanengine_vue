# 用户管理模块

## 1. 功能概述

| 功能 | 说明 |
|------|------|
| 用户列表 | 分页查询、条件筛选 |
| 创建用户 | 添加新用户 |
| 编辑用户 | 修改用户信息 |
| 删除用户 | 软删除用户 |
| 重置密码 | 管理员重置用户密码 |
| 修改密码 | 用户自行修改密码 |
| 用户登录 | JWT 认证 |
| 登出 | 清除 Token |

## 2. 数据模型

### 2.1 用户表 (sys_user)

```go
// backend/internal/app/admin/model/user.go
type User struct {
    ID          uint64         `gorm:"primaryKey" json:"id"`
    Username    string         `gorm:"size:64;uniqueIndex" json:"username"`
    Password    string         `gorm:"size:128" json:"-"`           // 不返回前端
    Nickname    string         `gorm:"size:128" json:"nickname"`
    Phone       string         `gorm:"size:20;index" json:"phone"`
    Email       string         `gorm:"size:128;index" json:"email"`
    Avatar      string         `gorm:"size:255" json:"avatar"`
    Status      int8           `gorm:"default:1;index" json:"status"` // 0-禁用,1-启用,2-锁定
    RoleID      uint64         `gorm:"index" json:"role_id"`
    DeptID      uint64         `gorm:"default:0" json:"dept_id"`
    LastLoginAt *time.Time     `json:"last_login_at"`
    LastLoginIP string         `gorm:"size:50" json:"last_login_ip"`
    Remark      string         `gorm:"size:500" json:"remark"`
    CreatedAt   time.Time      `json:"created_at"`
    UpdatedAt   time.Time      `json:"updated_at"`
    DeletedAt   gorm.DeletedAt `gorm:"index" json:"-"`
    CreatedBy   uint64         `gorm:"default:0" json:"created_by"`
    UpdatedBy   uint64         `gorm:"default:0" json:"updated_by"`

    // 关联
    Role *Role `gorm:"foreignKey:RoleID" json:"role,omitempty"`
}
```

### 2.2 用户状态常量

```go
const (
    UserStatusDisabled = 0  // 禁用
    UserStatusEnabled  = 1  // 启用
    UserStatusLocked   = 2  // 锁定
)
```

## 3. 服务层实现

### 3.1 创建用户

```go
// backend/internal/app/admin/service/user.go
func (s *UserService) Create(ctx context.Context, req *dto.UserCreateReq, operatorID uint64) error {
    // 1. 检查用户名是否已存在
    var count int64
    s.db.Model(&model.User{}).Where("username = ?", req.Username).Count(&count)
    if count > 0 {
        return errcode.New(errcode.ErrUserExists)
    }

    // 2. 加密密码 (bcrypt)
    hashedPassword, _ := auth.HashPassword(req.Password)

    // 3. 创建用户
    user := &model.User{
        Username:  req.Username,
        Password:  hashedPassword,
        Nickname:  req.Nickname,
        // ...
    }
    return s.db.Create(user).Error
}
```

### 3.2 用户登录

```go
// backend/internal/app/admin/service/auth.go
func (s *AuthService) Login(ctx context.Context, req *dto.LoginReq, clientIP string) (*dto.LoginResp, error) {
    // 1. 获取用户
    var user model.User
    err := s.db.Preload("Role").Where("username = ?", req.Username).First(&user).Error
    if err != nil {
        return nil, errcode.New(errcode.ErrPasswordWrong)
    }

    // 2. 检查用户状态
    if user.Status == model.UserStatusDisabled {
        return nil, errcode.New(errcode.ErrAccountDisabled)
    }
    if user.Status == model.UserStatusLocked {
        return nil, errcode.New(errcode.ErrAccountLocked)
    }

    // 3. 验证密码
    if !auth.VerifyPassword(req.Password, user.Password) {
        return nil, errcode.New(errcode.ErrPasswordWrong)
    }

    // 4. 生成 JWT Token
    claims := &auth.Claims{
        UserID:    int64(user.ID),
        Username:  user.Username,
        RoleKey:   user.Role.Key,
        RoleID:    int64(user.RoleID),
        DataScope: string(rune('0' + user.Role.DataScope)),
    }
    accessToken, _ := s.jwtManager.GenerateToken(claims)
    refreshToken, _ := s.jwtManager.GenerateRefreshToken(int64(user.ID))

    // 5. 更新登录信息
    s.db.Model(&user).Updates(map[string]interface{}{
        "last_login_at": time.Now(),
        "last_login_ip": clientIP,
    })

    return &dto.LoginResp{
        AccessToken:  accessToken,
        RefreshToken: refreshToken,
        ExpiresIn:    int64(s.jwtManager.GetAccessExpire().Seconds()),
        // ...
    }, nil
}
```

### 3.3 修改密码

```go
func (s *UserService) ChangePassword(ctx context.Context, userID uint64, req *dto.UserChangePasswordReq) error {
    var user model.User
    if err := s.db.First(&user, userID).Error; err != nil {
        return errcode.New(errcode.ErrUserNotFound)
    }

    // 验证旧密码
    if !auth.VerifyPassword(req.OldPassword, user.Password) {
        return errcode.New(errcode.ErrPasswordWrong)
    }

    // 加密新密码
    hashedPassword, _ := auth.HashPassword(req.NewPassword)
    return s.db.Model(&user).Update("password", hashedPassword).Error
}
```

## 4. API 接口

### 4.1 公开接口

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | `/api/v1/auth/login` | 用户登录 |
| POST | `/api/v1/auth/refresh` | 刷新 Token |
| GET | `/api/v1/auth/captcha` | 获取验证码 |

### 4.2 需认证接口

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/api/v1/auth/userinfo` | 获取当前用户信息 |
| POST | `/api/v1/auth/logout` | 登出 |
| GET | `/api/v1/system/users` | 用户列表 |
| POST | `/api/v1/system/users` | 创建用户 |
| GET | `/api/v1/system/users/:id` | 用户详情 |
| PUT | `/api/v1/system/users/:id` | 更新用户 |
| DELETE | `/api/v1/system/users/:id` | 删除用户 |
| POST | `/api/v1/system/users/:id/reset-password` | 重置密码 |
| POST | `/api/v1/system/users/change-password` | 修改密码 |

## 5. DTO 定义

### 5.1 登录请求/响应

```go
// dto/user.go
type LoginReq struct {
    Username string `json:"username" binding:"required"`
    Password string `json:"password" binding:"required"`
}

type LoginResp struct {
    AccessToken  string    `json:"access_token"`
    RefreshToken string    `json:"refresh_token"`
    ExpiresIn    int64     `json:"expires_in"`
    User         *UserInfo `json:"user"`
}

type UserInfo struct {
    ID       uint64   `json:"id"`
    Username string   `json:"username"`
    Nickname string   `json:"nickname"`
    Avatar   string   `json:"avatar"`
    Roles    []string `json:"roles"`
}
```

### 5.2 用户 CRUD 请求

```go
type UserCreateReq struct {
    Username string `json:"username" binding:"required,min=3,max=64"`
    Password string `json:"password" binding:"required,min=6,max=32"`
    Nickname string `json:"nickname" binding:"max=128"`
    Phone    string `json:"phone" binding:"max=20"`
    Email    string `json:"email" binding:"omitempty,email,max=128"`
    Avatar   string `json:"avatar" binding:"max=255"`
    Status   int8   `json:"status"`
    RoleID   uint64 `json:"role_id" binding:"required"`
    Remark   string `json:"remark" binding:"max=500"`
}

type UserUpdateReq struct {
    ID       uint64 `json:"id" binding:"required"`
    Nickname string `json:"nickname"`
    Phone    string `json:"phone"`
    Email    string `json:"email"`
    Avatar   string `json:"avatar"`
    Status   int8   `json:"status"`
    RoleID   uint64 `json:"role_id"`
    Remark   string `json:"remark"`
}
```

## 6. 前端实现

### 6.1 认证状态管理

```typescript
// frontend/src/stores/auth.ts
export const useAuthStore = defineStore('auth', {
  state: (): AuthState => ({
    token: localStorage.getItem('access_token'),
    refreshToken: localStorage.getItem('refresh_token'),
    userInfo: null,
    permissions: []
  }),

  actions: {
    async login(username: string, password: string) {
      const res = await authApi.login({ username, password })
      this.setToken(res.access_token, res.refresh_token)
      await this.fetchUserInfo()
      return true
    },

    async logout() {
      await authApi.logout()
      this.clearAuth()
      router.push('/login')
    },

    clearAuth() {
      this.token = null
      localStorage.removeItem('access_token')
      localStorage.removeItem('refresh_token')
    }
  }
})
```

### 6.2 路由守卫

```typescript
// frontend/src/router/guards.ts
router.beforeEach(async (to, from, next) => {
  const authStore = useAuthStore()
  
  if (to.meta.requiresAuth && !authStore.isLoggedIn) {
    next('/login')
  } else if (to.path === '/login' && authStore.isLoggedIn) {
    next('/')
  } else {
    next()
  }
})
```

## 7. 密码安全

### 7.1 密码加密

使用 bcrypt 算法:
```go
// pkg/auth/password.go
func HashPassword(password string) (string, error) {
    bytes, err := bcrypt.GenerateFromPassword([]byte(password), bcrypt.DefaultCost)
    return string(bytes), err
}

func VerifyPassword(password, hash string) bool {
    err := bcrypt.CompareHashAndPassword([]byte(hash), []byte(password))
    return err == nil
}
```

### 7.2 密码规则

`pkg/auth/password.go` 中 `ValidatePassword` 要求:
- 长度: 最少 8 位
- 必须包含: 大写字母、小写字母、数字、特殊字符

> 注: DTO 中 `binding:"min=6,max=32"` 是前端提交的基础验证；`ValidatePassword` 提供更严格的密码强度检测，但需业务层主动调用（当前服务层未强制调用）。

```bash
# 修改管理员密码
./scripts/change-admin-password.sh "YourNewPassword123!"  # 包含特殊字符
```

## 8. 注意事项

1. **密码不返回前端**: User 模型中 Password 字段使用 `json:"-"` 标签
2. **软删除**: 使用 GORM 的 DeletedAt 实现软删除
3. **操作审计**: CreatedBy/UpdatedBy 记录操作人
4. **并发安全**: 用户名唯一索引防止重复创建
